<%
    const [mainVal, mainValType] = ((option) => {
        switch(option){
            case 'readOne':
                return(['documentSnapshot', 'DocumentSnapshot<' + func["機能ＩＤ"] + func["機能名"] + 'Interface>']);
            case 'readArray':
                return(['querySnapshot', 'QuerySnapshot<' + func["機能ＩＤ"] + func["機能名"] + 'Interface>']);
            case 'readMap':
                return(['documentSnapshots', '{[id:string]: QueryDocumentSnapshot<' + func["機能ＩＤ"] + func["機能名"] + 'Interface>}']);
        }
    })(option);
-%>
import { ActivityIndicator } from 'react-native-paper';
import { useState, createContext, useEffect, ReactNode } from 'react';
import db from '@/<%- func["大分類"] %>/Endpoint/firestore'
import { collection, doc, query, QuerySnapshot, onSnapshot, addDoc, DocumentReference, DocumentSnapshot, QueryDocumentSnapshot } from 'firebase/firestore';
import { <%- table.t_id %><%- table.t_name %>Cols, collectionName, <%- table.t_id %><%- table.t_name %>Interface } from '@/<%- func["大分類"] %>/Models/<%- table.t_id %><%- table.t_name %>'
import { <%- func["機能ＩＤ"] %><%- func["機能名"] %>Interface } from './<%- func["機能名"] %>Interface';
import { <%- func["機能ＩＤ"] %><%- func["機能名"] %>Converter } from './<%- func["機能名"] %>Converter';
import { <%- func["機能ＩＤ"] %><%- func["機能名"] %>Build } from './<%- func["機能名"] %>Build';

/**
 * Define value interface of useContext(<%- func["機能ＩＤ"] %><%- func["機能名"] %>). 
 */
interface <%- func["機能ＩＤ"] %><%- func["機能名"] %>ValInterface {
    <%- mainVal %>: <%- mainValType %>;
    create: () => void;
}
export const <%- func["機能ＩＤ"] %><%- func["機能名"] %> = createContext({} as <%- func["機能ＩＤ"] %><%- func["機能名"] %>ValInterface);

/**
 * Export Provider of <%- func["機能ＩＤ"] %><%- func["機能名"] %>. 
 */
interface <%- func["機能ＩＤ"] %><%- func["機能名"] %>ProviderPropsInterface {
    parentDocRef?: DocumentReference;
    children: ReactNode;
<% if(option === 'readOne'){ -%>
    id: string;
<% } -%>
}
export const <%- func["機能ＩＤ"] %><%- func["機能名"] %>Provider = ({
    parentDocRef,
    children,
<% if(option === 'readOne'){ -%>
    id,
<% } -%>
}: <%- func["機能ＩＤ"] %><%- func["機能名"] %>ProviderPropsInterface) => {
    
    const [<%- mainVal %>, set<%- mainVal[0].toUpperCase() + mainVal.slice(1) %>] = useState<<%- func["機能ＩＤ"] %><%- func["機能名"] %>ValInterface['<%- mainVal %>']<% if(option!=="readMap"){ -%> | null<% } -%>>(<%- option!=="readMap" ? 'null' : '{}' %>);
    
    const collectionRef = parentDocRef
        ?   collection(parentDocRef, collectionName).withConverter(<%- func["機能ＩＤ"] %><%- func["機能名"] %>Converter())
        :   collection(db, collectionName).withConverter(<%- func["機能ＩＤ"] %><%- func["機能名"] %>Converter());

    useEffect(() => {
        const fetchData = async () => {
            const unsubscribe = onSnapshot(
<%- include('./'  + option + '/_onSnapshot', {func:func}) %>
            );
        }
        fetchData();
    }, [parentDocRef<% if(option==="readOne"){ -%>, id<% } -%>]);

    const create: <%- func["機能ＩＤ"] %><%- func["機能名"] %>ValInterface['create'] = async () => {
        addDoc<<%- func["機能ＩＤ"] %><%- func["機能名"] %>Interface>(collectionRef, <%- func["機能ＩＤ"] %><%- func["機能名"] %>Build());
    }

    if (!<%- mainVal %>) {
        return <ActivityIndicator animating={true} />
    }
    
    const value: <%- func["機能ＩＤ"] %><%- func["機能名"] %>ValInterface = {
        <%- mainVal %>,
        create,
    }
    return <<%- func["機能ＩＤ"] %><%- func["機能名"] %>.Provider value={value}>{children}</<%- func["機能ＩＤ"] %><%- func["機能名"] %>.Provider>
};
